<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Together - Real-time Video Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            overflow-x: hidden;
        }
        video::-webkit-media-controls-panel {
            display: none !important;
        }
        video::-webkit-media-controls {
            display: none !important;
        }
        .movie-item {
            transition: all 0.2s;
        }
        .movie-item:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
    <div id="app"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500 mx-auto mb-4"></div>
            <p class="text-white text-center font-semibold">Processing...</p>
            <p id="loadingText" class="text-white/70 text-center text-sm mt-2"></p>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAsRmqn4UU6Ots1Yx8m69T6gHAgEeQGcW8",
            authDomain: "watch-together-80f0e.firebaseapp.com",
            databaseURL: "https://watch-together-80f0e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "watch-together-80f0e",
            storageBucket: "watch-together-80f0e.firebasestorage.app",
            messagingSenderId: "1091604037251",
            appId: "1:1091604037251:web:d59e47e5ce5ccc479be5b6",
            measurementId: "G-R8PDK3MTS4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // App state
        const state = {
            roomId: '',
            isInRoom: false,
            isPlaying: false,
            currentTime: 0,
            duration: 0,
            isScreenSharing: false,
            isHost: false,
            viewers: 1,
            videoUrl: '',
            videoFileName: '',
            videoType: 'video',
            copied: false,
            userId: `user_${Math.random().toString(36).substr(2, 9)}`,
            lastUpdate: 0,
            lastUserAction: 0,
            screenStream: null,
            roomRef: null,
            volume: 1,
            isMuted: false,
            showDriveInstructions: false,
            showMovieLibrary: false,
            movieLibrary: [],
            showAddMovie: false
        };

        // Utility Functions
        function showLoading(text = 'Processing...') {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingText').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Load movie library from storage
        async function loadMovieLibrary() {
            try {
                const result = await window.storage.get('movie-library', true);
                if (result && result.value) {
                    state.movieLibrary = JSON.parse(result.value);
                }
            } catch (error) {
                console.log('No existing library or error loading:', error);
                state.movieLibrary = [];
            }
        }

        // Save movie library to storage
        async function saveMovieLibrary() {
            try {
                await window.storage.set('movie-library', JSON.stringify(state.movieLibrary), true);
            } catch (error) {
                console.error('Error saving library:', error);
                alert('Failed to save movie library');
            }
        }

        // Add movie to library
        async function addMovieToLibrary() {
            const title = document.getElementById('movieTitle')?.value.trim();
            const url = document.getElementById('movieUrl')?.value.trim();
            const thumbnail = document.getElementById('movieThumbnail')?.value.trim();
            
            if (!title || !url) {
                alert('Please enter both title and URL');
                return;
            }
            
            const movie = {
                id: Date.now().toString(),
                title,
                url: url,
                originalUrl: url,
                thumbnail: thumbnail || '🎬',
                addedBy: state.userId,
                addedAt: Date.now()
            };
            
            state.movieLibrary.push(movie);
            await saveMovieLibrary();
            
            state.showAddMovie = false;
            render();
            
            alert('Movie added to library!');
        }

        // Delete movie from library
        async function deleteMovie(movieId) {
            if (!confirm('Delete this movie from the library?')) return;
            
            state.movieLibrary = state.movieLibrary.filter(m => m.id !== movieId);
            await saveMovieLibrary();
            render();
        }

        // Convert Google Drive link to embeddable link
        function convertToDirectLink(url) {
            // Google Drive file link (multiple formats)
            let driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (driveMatch) {
                return `https://drive.google.com/file/d/${driveMatch[1]}/preview`;
            }
            
            // Check if it's already a preview link
            if (url.includes('drive.google.com') && url.includes('/preview')) {
                return url;
            }
            
            // Gofile link
            if (url.includes('gofile.io')) {
                return url;
            }
            
            // Google Drive folder link
            if (url.includes('drive.google.com/drive/folders')) {
                return url;
            }
            
            // Already a direct link
            return url;
        }

        // Get video source type
        function getVideoSource(url) {
            if (url.includes('drive.google.com') && url.includes('/preview')) {
                return { type: 'iframe', url: url };
            }
            return { type: 'video', url: url };
        }

        // Load movie from library
        function loadMovieFromLibrary(movie) {
            state.showMovieLibrary = false;
            handleVideoUrl(movie.originalUrl, movie.title);
        }

        // Toggle movie library
        function toggleMovieLibrary() {
            state.showMovieLibrary = !state.showMovieLibrary;
            if (state.showMovieLibrary && state.movieLibrary.length === 0) {
                loadMovieLibrary().then(render);
            } else {
                render();
            }
        }

        // Toggle add movie form
        function toggleAddMovie() {
            state.showAddMovie = !state.showAddMovie;
            render();
        }

        // Toggle drive instructions
        function toggleDriveInstructions() {
            state.showDriveInstructions = !state.showDriveInstructions;
            render();
        }

        // Open upload instructions
        function openUploadInstructions() {
            const instructions = `
📤 How to Upload Videos:

Option 1: Google Drive (Recommended)
1. Go to https://drive.google.com/drive/folders/1MqJWy29egTrC93cTRTVJnIOoiT3Moc_X
2. Upload your video file
3. Right-click → Share → "Anyone with the link"
4. Copy the link and paste it in the video URL field

Option 2: Gofile (Simple & Free)
1. Go to https://gofile.io/uploadFiles
2. Upload your video (no account needed)
3. Copy the download link
4. Paste it in the video URL field

💡 Tips:
- Google Drive: Best for large files (up to 5TB!)
- Gofile: Quick uploads, works great for files up to 10GB
- Both services are free and don't require registration
            `;
            
            alert(instructions);
        }

        // Join or create room
        function joinRoom(id) {
            showLoading('Joining room...');
            state.roomId = id;
            state.roomRef = db.ref(`rooms/${id}`);
            
            state.roomRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    state.isHost = false;
                    const data = snapshot.val();
                    state.isPlaying = data.isPlaying || false;
                    state.currentTime = data.currentTime || 0;
                    state.videoUrl = data.videoUrl || '';
                    state.videoFileName = data.videoFileName || '';
                    state.duration = data.duration || 0;
                    state.videoType = data.videoType || 'video';
                    
                    setTimeout(() => {
                        if (state.videoUrl) {
                            if (state.videoType === 'iframe') {
                                render();
                            } else {
                                const video = document.getElementById('videoPlayer');
                                if (video) {
                                    video.src = state.videoUrl;
                                    video.currentTime = data.currentTime || 0;
                                    if (state.isPlaying) {
                                        video.play().catch(e => console.log('Autoplay prevented'));
                                    }
                                }
                            }
                        }
                    }, 100);
                } else {
                    state.isHost = true;
                    state.roomRef.set({
                        isPlaying: false,
                        currentTime: 0,
                        duration: 0,
                        videoUrl: '',
                        videoFileName: '',
                        videoType: 'video',
                        host: state.userId,
                        createdAt: Date.now()
                    });
                }
                
                state.isInRoom = true;
                hideLoading();
                render();
                setupRoomListeners();
            }).catch(error => {
                console.error('Error joining room:', error);
                alert('Failed to join room. Please try again.');
                hideLoading();
            });
        }

        // Setup room listeners
        function setupRoomListeners() {
            let isUpdating = false;
            
            state.roomRef.on('value', (snapshot) => {
                if (snapshot.exists() && !isUpdating) {
                    const data = snapshot.val();
                    const video = document.getElementById('videoPlayer');
                    
                    // Update video URL if changed
                    if (data.videoUrl !== state.videoUrl && !state.isScreenSharing) {
                        state.videoUrl = data.videoUrl;
                        state.videoFileName = data.videoFileName || '';
                        state.videoType = data.videoType || 'video';
                        
                        if (state.videoType === 'video' && video && data.videoUrl) {
                            video.src = data.videoUrl;
                            video.load();
                            video.currentTime = data.currentTime || 0;
                            
                            if (data.isPlaying) {
                                video.play().catch(e => console.log('Play prevented'));
                            }
                        }
                        render();
                    }
                    
                    // Sync play/pause state
                    if (data.isPlaying !== state.isPlaying) {
                        state.isPlaying = data.isPlaying;
                        
                        if (video && !state.isScreenSharing && state.videoType === 'video') {
                            if (data.isPlaying) {
                                // Sync time before playing
                                if (data.currentTime) {
                                    video.currentTime = data.currentTime;
                                }
                                video.play().catch(e => console.log('Play prevented'));
                            } else {
                                video.pause();
                                // Sync time when pausing
                                if (data.currentTime) {
                                    video.currentTime = data.currentTime;
                                }
                            }
                        }
                        render();
                    }
                    
                    // Sync time if difference is significant
                    if (video && !state.isScreenSharing && state.videoType === 'video' && data.currentTime) {
                        const timeDiff = Math.abs(video.currentTime - data.currentTime);
                        if (timeDiff > 2) {
                            video.currentTime = data.currentTime;
                        }
                    }
                    
                    // Update duration
                    if (data.duration && data.duration !== state.duration) {
                        state.duration = data.duration;
                        render();
                    }
                    
                    // Update current time for display
                    if (data.currentTime !== undefined) {
                        state.currentTime = data.currentTime;
                        render();
                    }
                }
            });

            const viewersRef = db.ref(`rooms/${state.roomId}/viewers`);
            const userRef = viewersRef.child(state.userId);
            userRef.set({
                joinedAt: Date.now(),
                userId: state.userId
            });
            userRef.onDisconnect().remove();

            viewersRef.on('value', (snapshot) => {
                state.viewers = snapshot.numChildren();
                render();
            });

            setInterval(() => {
                if (state.isPlaying && !state.isScreenSharing && state.videoType === 'video') {
                    const video = document.getElementById('videoPlayer');
                    if (video && !isNaN(video.currentTime)) {
                        // Only update periodically while playing, don't override user actions
                        const now = Date.now();
                        if (!state.lastUserAction || now - state.lastUserAction > 3000) {
                            updateRoom({ 
                                currentTime: video.currentTime,
                                duration: video.duration || state.duration
                            });
                        }
                    }
                }
            }, 2000);
        }

        // Update room state
        function updateRoom(updates) {
            if (state.roomRef) {
                state.roomRef.update(updates).catch(e => console.error('Update error:', e));
            }
        }

        // Toggle play/pause
        function togglePlay() {
            if (state.videoType === 'iframe') {
                alert('Google Drive videos play automatically. Use the controls in the video player.');
                return;
            }
            
            const video = document.getElementById('videoPlayer');
            if (!video || (!state.videoUrl && !state.isScreenSharing)) return;
            
            state.isPlaying = !state.isPlaying;
            
            if (state.isPlaying) {
                video.play().catch(e => {
                    console.error('Play error:', e);
                    state.isPlaying = false;
                });
            } else {
                video.pause();
            }
            
            // Immediately update room with current state
            updateRoom({
                isPlaying: state.isPlaying,
                currentTime: video.currentTime || 0,
                lastActionBy: state.userId,
                lastActionTime: Date.now()
            });
            render();
        }

        // Seek video
        function seekVideo(percentage) {
            if (state.videoType === 'iframe') return;
            
            const video = document.getElementById('videoPlayer');
            if (!video || !state.duration) return;
            
            const newTime = (percentage / 100) * state.duration;
            video.currentTime = newTime;
            state.currentTime = newTime;
            
            // Immediately update room with seek position
            updateRoom({ 
                currentTime: newTime,
                isPlaying: state.isPlaying,
                lastActionBy: state.userId,
                lastActionTime: Date.now()
            });
            render();
        }

        // Volume control
        function changeVolume(value) {
            if (state.videoType === 'iframe') return;
            
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            state.volume = value / 100;
            video.volume = state.volume;
            state.isMuted = state.volume === 0;
            render();
        }

        function toggleMute() {
            if (state.videoType === 'iframe') return;
            
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            state.isMuted = !state.isMuted;
            video.muted = state.isMuted;
            render();
        }

        // Handle video URL
        function handleVideoUrl(url, fileName = '') {
            if (!url.trim()) return;
            
            const directUrl = convertToDirectLink(url);
            state.videoUrl = directUrl;
            state.videoFileName = fileName || url.split('/').pop();
            
            const videoSource = getVideoSource(directUrl);
            state.videoType = videoSource.type;
            
            updateRoom({ 
                videoUrl: directUrl,
                videoFileName: state.videoFileName,
                videoType: videoSource.type
            });
            
            render();
            
            setTimeout(() => {
                if (videoSource.type === 'video') {
                    const video = document.getElementById('videoPlayer');
                    if (video) {
                        video.src = directUrl;
                        video.load();
                        
                        video.onloadedmetadata = () => {
                            state.duration = video.duration;
                            updateRoom({ duration: video.duration });
                        };
                        
                        video.onerror = () => {
                            alert('Failed to load video. Please check:\n1. The link is a direct video URL\n2. The file is shared publicly (Anyone with link can view)\n3. For Google Drive: Make sure sharing is enabled');
                        };
                    }
                }
            }, 100);
        }

        // Toggle screen share
        async function toggleScreenShare() {
            if (!state.isScreenSharing) {
                try {
                    showLoading('Starting screen share...');
                    
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            frameRate: { ideal: 60, max: 60 },
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: true
                    });

                    state.screenStream = stream;
                    state.isScreenSharing = true;
                    state.isPlaying = true;
                    state.videoType = 'video';
                    
                    hideLoading();
                    render();
                    
                    setTimeout(() => {
                        const video = document.getElementById('videoPlayer');
                        if (video) {
                            video.srcObject = stream;
                            video.muted = true;
                            video.play().catch(e => console.error('Play error:', e));
                        }
                    }, 100);

                    stream.getVideoTracks()[0].onended = () => {
                        stopScreenShare();
                    };

                    updateRoom({ 
                        isScreenSharing: true, 
                        screenHost: state.userId,
                        isPlaying: true 
                    });
                } catch (error) {
                    console.error('Screen share error:', error);
                    if (error.name === 'NotAllowedError') {
                        alert('Screen sharing permission denied. Please allow screen sharing to continue.');
                    } else {
                        alert('Screen sharing failed. Please try again.');
                    }
                    state.isScreenSharing = false;
                    hideLoading();
                    render();
                }
            } else {
                stopScreenShare();
            }
        }

        // Stop screen share
        function stopScreenShare() {
            if (state.screenStream) {
                state.screenStream.getTracks().forEach(track => track.stop());
                state.screenStream = null;
            }
            
            state.isScreenSharing = false;
            state.isPlaying = false;
            
            updateRoom({ 
                isScreenSharing: false, 
                screenHost: null,
                isPlaying: false 
            });
            
            render();
            
            setTimeout(() => {
                const video = document.getElementById('videoPlayer');
                if (video) {
                    video.srcObject = null;
                    video.muted = false;
                    if (state.videoUrl && state.videoType === 'video') {
                        video.src = state.videoUrl;
                    }
                }
            }, 100);
        }

        // Copy room ID
        function copyRoomId() {
            navigator.clipboard.writeText(state.roomId).then(() => {
                state.copied = true;
                render();
                setTimeout(() => {
                    state.copied = false;
                    render();
                }, 2000);
            }).catch(e => {
                alert('Failed to copy room ID');
            });
        }

        // Leave room
        function leaveRoom() {
            if (state.roomRef) {
                db.ref(`rooms/${state.roomId}/viewers/${state.userId}`).remove();
            }
            
            if (state.isScreenSharing) {
                stopScreenShare();
            }
            
            state.isInRoom = false;
            state.roomId = '';
            state.videoUrl = '';
            state.isPlaying = false;
            state.videoType = 'video';
            render();
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            
            if (!state.isInRoom) {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full shadow-2xl border border-white/20">
                            <div class="text-center mb-8">
                                <h1 class="text-5xl font-bold text-white mb-2">🎬 Watch Together</h1>
                                <p class="text-white/70">Real-time video synchronization</p>
                            </div>
                            
                            <div class="space-y-4">
                                <button onclick="joinRoom(generateRoomId())" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                                    🚀 Create New Room
                                </button>
                                
                                <div class="relative">
                                    <div class="absolute inset-0 flex items-center">
                                        <div class="w-full border-t border-white/30"></div>
                                    </div>
                                    <div class="relative flex justify-center text-sm">
                                        <span class="px-2 bg-transparent text-white/70">or</span>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    <input id="roomInput" type="text" placeholder="Enter Room ID" class="w-full bg-white/20 border border-white/30 rounded-xl px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 uppercase" onkeypress="if(event.key==='Enter' && this.value.trim()) joinRoom(this.value.trim().toUpperCase())">
                                    <button onclick="const input = document.getElementById('roomInput'); if(input.value.trim()) joinRoom(input.value.trim().toUpperCase())" class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-6 rounded-xl transition-all border border-white/30">
                                        🔗 Join Room
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-8 p-4 bg-white/5 rounded-xl border border-white/10">
                                <h3 class="text-white font-semibold mb-2">✨ Features:</h3>
                                <ul class="text-white/70 text-sm space-y-1">
                                    <li>• Real-time video sync</li>
                                    <li>• 60 FPS screen sharing</li>
                                    <li>• Google Drive & Gofile support</li>
                                    <li>• Shared movie library</li>
                                    <li>• Multi-viewer support</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const progressPercent = state.duration > 0 ? (state.currentTime / state.duration) * 100 : 0;
                
                app.innerHTML = `
                    <div class="min-h-screen p-4">
                        <div class="max-w-6xl mx-auto">
                            <!-- Header -->
                            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 md:p-6 shadow-2xl border border-white/20 mb-4">
                                <div class="flex items-center justify-between flex-wrap gap-4">
                                    <div class="flex items-center gap-3">
                                        <button onclick="leaveRoom()" class="bg-red-500/20 hover:bg-red-500/30 text-red-200 px-4 py-2 rounded-lg transition-all border border-red-500/30 font-semibold">
                                            ← Leave
                                        </button>
                                        <div>
                                            <h2 class="text-xl md:text-2xl font-bold text-white">Room: ${state.roomId}</h2>
                                            ${state.videoFileName ? `<p class="text-white/60 text-sm">${state.videoFileName}</p>` : ''}
                                        </div>
                                        <button onclick="copyRoomId()" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg transition-all text-sm">
                                            ${state.copied ? '✓ Copied!' : '📋 Copy ID'}
                                        </button>
                                    </div>
                                    
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2 text-white bg-white/20 px-4 py-2 rounded-lg">
                                            <span class="text-lg">👥</span>
                                            <span class="font-semibold">${state.viewers}</span>
                                        </div>
                                        
                                        ${state.isHost ? `
                                            <button onclick="toggleScreenShare()" class="flex items-center gap-2 px-4 py-2 rounded-lg transition-all font-semibold ${
                                                state.isScreenSharing
                                                    ? 'bg-red-500 hover:bg-red-600 text-white'
                                                    : 'bg-green-500 hover:bg-green-600 text-white'
                                            }">
                                                <span class="text-lg">${state.isScreenSharing ? '🛑' : '📺'}</span>
                                                <span class="hidden sm:inline">${state.isScreenSharing ? 'Stop Share' : 'Share Screen'}</span>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>

                            <!-- Video Player -->
                            <div class="bg-black rounded-2xl overflow-hidden shadow-2xl mb-4 relative">
                                ${state.videoType === 'iframe' && state.videoUrl ? `
                                    <iframe 
                                        src="${state.videoUrl}" 
                                        class="w-full aspect-video bg-black"
                                        allow="autoplay"
                                        allowfullscreen
                                    ></iframe>
                                ` : `
                                    <video 
                                        id="videoPlayer" 
                                        class="w-full aspect-video bg-black" 
                                        ${state.videoUrl && !state.isScreenSharing ? `src="${state.videoUrl}"` : ''} 
                                        ontimeupdate="state.currentTime = this.currentTime; render()" 
                                        onloadedmetadata="state.duration = this.duration; render()"
                                        ${state.isScreenSharing ? 'muted' : ''}
                                        playsinline
                                    ></video>
                                `}
                                
                                ${!state.videoUrl && !state.isScreenSharing ? `
                                    <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-purple-900/50 to-blue-900/50">
                                        <div class="text-center">
                                            <div class="text-6xl mb-4">🎬</div>
                                            <p class="text-white text-xl font-semibold">No video loaded</p>
                                            <p class="text-white/70 mt-2">${state.isHost ? 'Choose from library, paste URL, or share your screen' : 'Waiting for host to start'}</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Controls -->
                            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 md:p-6 shadow-2xl border border-white/20">
                                ${state.isHost && !state.isScreenSharing ? `
                                    <div class="mb-6 space-y-4">
                                        <!-- Movie Library Button -->
                                        <div class="flex gap-2">
                                            <button onclick="toggleMovieLibrary()" class="flex-1 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-6 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                                                <span class="text-xl">📚</span>
                                                <span>Movie Library (${state.movieLibrary.length})</span>
                                            </button>
                                            <button onclick="openUploadInstructions()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-3 rounded-xl font-semibold transition-all">
                                                <span class="text-xl">❓</span>
                                            </button>
                                        </div>
                                        
                                        <!-- Movie Library Panel -->
                                        ${state.showMovieLibrary ? `
                                            <div class="bg-white/10 border border-white/20 rounded-xl p-4 space-y-3">
                                                <div class="flex items-center justify-between">
                                                    <h3 class="text-white font-semibold text-lg">📚 Movie Library</h3>
                                                    <div class="flex gap-2">
                                                        <button onclick="toggleAddMovie()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold transition-all">
                                                            + Add Movie
                                                        </button>
                                                        <button onclick="toggleMovieLibrary()" class="bg-red-500/20 hover:bg-red-500/30 text-red-200 px-3 py-1.5 rounded-lg text-sm font-semibold transition-all">
                                                            Close
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Add Movie Form -->
                                                ${state.showAddMovie ? `
                                                    <div class="bg-white/10 border border-white/20 rounded-lg p-4 space-y-3">
                                                        <h4 class="text-white font-semibold">Add New Movie</h4>
                                                        <input 
                                                            id="movieTitle" 
                                                            type="text" 
                                                            placeholder="Movie Title" 
                                                            class="w-full bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                        >
                                                        <input 
                                                            id="movieUrl" 
                                                            type="text" 
                                                            placeholder="Google Drive or Gofile URL" 
                                                            class="w-full bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                        >
                                                        <input 
                                                            id="movieThumbnail" 
                                                            type="text" 
                                                            placeholder="Thumbnail emoji or URL (optional, default: 🎬)" 
                                                            class="w-full bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                        >
                                                        <div class="flex gap-2">
                                                            <button onclick="addMovieToLibrary()" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                                                💾 Save
                                                            </button>
                                                            <button onclick="toggleAddMovie()" class="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-200 px-4 py-2 rounded-lg font-semibold transition-all">
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                
                                                <!-- Movie List -->
                                                <div class="max-h-96 overflow-y-auto space-y-2">
                                                    ${state.movieLibrary.length === 0 ? `
                                                        <div class="text-center text-white/70 py-8">
                                                            <p class="text-4xl mb-2">🎬</p>
                                                            <p>No movies in library yet</p>
                                                            <p class="text-sm mt-1">Click "Add Movie" to get started</p>
                                                        </div>
                                                    ` : state.movieLibrary.map(movie => `
                                                        <div class="movie-item bg-white/10 border border-white/20 rounded-lg p-3 flex items-center gap-3 hover:bg-white/20 transition-all">
                                                            <div class="text-3xl flex-shrink-0">${movie.thumbnail.startsWith('http') ? `<img src="${movie.thumbnail}" class="w-12 h-12 object-cover rounded" onerror="this.outerHTML='🎬'" />` : movie.thumbnail}</div>
                                                            <div class="flex-1 min-w-0">
                                                                <h4 class="text-white font-semibold truncate">${movie.title}</h4>
                                                                <p class="text-white/60 text-xs truncate">${new Date(movie.addedAt).toLocaleDateString()}</p>
                                                            </div>
                                                            <div class="flex gap-2 flex-shrink-0">
                                                                <button onclick='loadMovieFromLibrary(${JSON.stringify(movie).replace(/'/g, "&#39;")})' class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold transition-all">
                                                                    ▶️ Play
                                                                </button>
                                                                <button onclick="deleteMovie('${movie.id}')" class="bg-red-500/20 hover:bg-red-500/30 text-red-200 px-3 py-1.5 rounded-lg text-sm font-semibold transition-all">
                                                                    🗑️
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        <div>
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="block text-white text-sm font-semibold">🎬 Or Paste Video URL</label>
                                                <button onclick="toggleDriveInstructions()" class="text-purple-300 hover:text-purple-200 text-xs underline">
                                                    ${state.showDriveInstructions ? 'Hide' : 'How to upload?'}
                                                </button>
                                            </div>
                                            
                                            ${state.showDriveInstructions ? `
                                                <div class="mb-3 p-4 bg-blue-500/20 border border-blue-500/30 rounded-lg text-white text-sm space-y-2">
                                                    <p class="font-semibold">📝 Upload Options:</p>
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-semibold text-purple-300">Option 1: Google Drive</p>
                                                            <ol class="list-decimal list-inside space-y-1 text-white/90 text-xs ml-2">
                                                                <li>Upload to: <a href="https://drive.google.com/drive/folders/1MqJWy29egTrC93cTRTVJnIOoiT3Moc_X" target="_blank" class="underline">Shared Drive Folder</a></li>
                                                                <li>Right-click → Share → "Anyone with the link"</li>
                                                                <li>Copy link and paste below</li>
                                                            </ol>
                                                        </div>
                                                        <div>
                                                            <p class="font-semibold text-cyan-300">Option 2: Gofile</p>
                                                            <ol class="list-decimal list-inside space-y-1 text-white/90 text-xs ml-2">
                                                                <li>Go to: <a href="https://gofile.io/uploadFiles" target="_blank" class="underline">Gofile.io</a></li>
                                                                <li>Upload your video (no account needed)</li>
                                                                <li>Copy download link and paste below</li>
                                                            </ol>
                                                        </div>
                                                    </div>
                                                    <p class="text-xs text-white/70 mt-2">✨ Both services are free and support large files!</p>
                                                </div>
                                            ` : ''}
                                            
                                            <div class="flex gap-2">
                                                <input 
                                                    id="videoUrlInput" 
                                                    type="text" 
                                                    placeholder="Paste Google Drive or Gofile link" 
                                                    value="${state.videoUrl}" 
                                                    class="flex-1 bg-white/20 border border-white/30 rounded-xl px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    onkeypress="if(event.key==='Enter') handleVideoUrl(this.value)"
                                                >
                                                <button onclick="handleVideoUrl(document.getElementById('videoUrlInput').value)" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                                    Load
                                                </button>
                                            </div>
                                            
                                            <p class="text-white/60 text-xs mt-2">
                                                💡 Supports: Google Drive, Gofile, and direct video URLs
                                            </p>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Progress Bar -->
                                ${state.duration > 0 && state.videoType === 'video' ? `
                                    <div class="mb-4">
                                        <div class="flex justify-between text-white text-sm mb-2">
                                            <span>${formatTime(state.currentTime)}</span>
                                            <span>${formatTime(state.duration)}</span>
                                        </div>
                                        <div class="w-full bg-white/20 rounded-full h-2 cursor-pointer" onclick="const rect = this.getBoundingClientRect(); const percent = ((event.clientX - rect.left) / rect.width) * 100; seekVideo(percent);">
                                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Playback Controls -->
                                <div class="flex items-center justify-between gap-4 flex-wrap">
                                    <div class="flex items-center gap-3">
                                        ${state.videoType === 'video' ? `
                                            <button 
                                                onclick="togglePlay()" 
                                                ${(!state.videoUrl && !state.isScreenSharing) ? 'disabled' : ''} 
                                                class="flex items-center gap-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg"
                                            >
                                                <span class="text-xl">${state.isPlaying ? '⏸️' : '▶️'}</span>
                                                <span>${state.isPlaying ? 'Pause' : 'Play'}</span>
                                            </button>
                                        ` : `
                                            <div class="bg-blue-500/20 border border-blue-500/30 text-blue-200 py-3 px-6 rounded-xl">
                                                <span class="text-sm">🎬 Use video player controls</span>
                                            </div>
                                        `}
                                    </div>
                                    
                                    ${state.videoType === 'video' ? `
                                        <div class="flex items-center gap-3">
                                            <button onclick="toggleMute()" class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg transition-all">
                                                <span class="text-xl">${state.isMuted || state.volume === 0 ? '🔇' : state.volume < 0.5 ? '🔉' : '🔊'}</span>
                                            </button>
                                            <input 
                                                type="range" 
                                                min="0" 
                                                max="100" 
                                                value="${state.volume * 100}" 
                                                oninput="changeVolume(this.value)"
                                                class="w-24 accent-purple-500"
                                            >
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="mt-4 p-3 bg-green-500/20 border border-green-500/30 rounded-lg">
                                    <p class="text-green-200 text-sm text-center">
                                        ✨ Everyone can control playback! Any user can play, pause, or seek the video.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Initial render
        render();
        
        // Load movie library on startup
        loadMovieLibrary();
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && state.isInRoom && state.roomRef) {
                state.roomRef.once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (state.videoType === 'video') {
                            const video = document.getElementById('videoPlayer');
                            if (video && !state.isScreenSharing) {
                                video.currentTime = data.currentTime || 0;
                                if (data.isPlaying) {
                                    video.play().catch(e => console.log('Play prevented'));
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
